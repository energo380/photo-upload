<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 520px;
      width: 100%;
    }

    .company-name {
      color: #dc143c;
      font-size: 20px;
      font-weight: bold;
      line-height: 1.4;
      margin-bottom: 15px;
      text-align: center;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }

    .upload-area {
      border: 3px dashed #667eea;
      border-radius: 15px;
      padding: 40px;
      text-align: center;
      background: #f8f9ff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-area:hover {
      background: #e8ebff;
      border-color: #764ba2;
    }

    .upload-icon { font-size: 60px; margin-bottom: 20px; }
    .upload-text { color: #666; font-size: 18px; margin-bottom: 10px; }
    .upload-hint { color: #999; font-size: 14px; }

    input[type="file"] { display: none; }

    .preview { margin-top: 22px; text-align: center; }
    .preview img {
      max-width: 100%;
      max-height: 380px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .meta {
      margin-top: 10px;
      font-size: 13px;
      color: #666;
      text-align: center;
    }

    .button-group {
      margin-top: 22px;
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .btn {
      padding: 14px 26px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: bold;
    }

    .btn-send { background: #4CAF50; color: white; }
    .btn-send:hover { background: #45a049; transform: translateY(-1px); }

    .btn-send:disabled { background: #cccccc; cursor: not-allowed; transform: none; }

    .btn-cancel { background: #f44336; color: white; }
    .btn-cancel:hover { background: #da190b; transform: translateY(-1px); }

    #status {
      margin-top: 18px;
      padding: 14px;
      border-radius: 10px;
      text-align: center;
      font-weight: bold;
      display: none;
      word-break: break-word;
    }

    .status-success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
    .status-error   { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
    .status-loading { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div class="container">
    <div class="company-name">
      –†–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π<br>
      –ê–û "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –ø—Ç–∏—Ü–µ—Ñ–∞–±—Ä–∏–∫–∞"
    </div>

    <h1>üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</h1>

    <form id="photoForm">
      <label for="photo" class="upload-area" id="uploadArea">
        <div class="upload-icon">üì∑</div>
        <div class="upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ</div>
        <div class="upload-hint">–∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ —Å–Ω–∏–º–æ–∫ –∫–∞–º–µ—Ä–æ–π</div>
      </label>
      <input type="file" id="photo" name="photo" accept="image/*" capture="environment" required>

      <div class="preview" id="preview"></div>
      <div class="meta" id="meta"></div>

      <div class="button-group" id="buttonGroup" style="display:none;">
        <button type="submit" class="btn btn-send" id="sendBtn">‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <button type="button" class="btn btn-cancel" id="cancelBtn">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>
    </form>

    <div id="status"></div>
  </div>

  <script>
    // === Web3Forms –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    const WEB3FORMS_ACCESS_KEY = "d5431e0c-180c-402a-ad50-ec4a38a36a2c";
    const TO_EMAIL = "oge@energo-380.ru";

    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/—Å–∂–∞—Ç–∏–µ, —á—Ç–æ–±—ã –ø–∏—Å—å–º–æ –Ω–µ —Å—Ç–∞–ª–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º
    const MAX_ORIGINAL_MB = 12;           // –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª –º–∞–∫—Å–∏–º—É–º
    const JPEG_QUALITY = 0.7;             // –∫–∞—á–µ—Å—Ç–≤–æ —Å–∂–∞—Ç–∏—è (0..1)
    const MAX_SIDE = 1600;                // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (px)
    const MAX_BASE64_CHARS = 800_000;     // –ª–∏–º–∏—Ç —Ç–µ–∫—Å—Ç–∞ base64 –≤ –ø–∏—Å—å–º–µ (–ø—Ä–∏–º–µ—Ä–Ω–æ)

    const photoInput = document.getElementById("photo");
    const preview = document.getElementById("preview");
    const meta = document.getElementById("meta");
    const buttonGroup = document.getElementById("buttonGroup");
    const form = document.getElementById("photoForm");
    const status = document.getElementById("status");
    const cancelBtn = document.getElementById("cancelBtn");
    const sendBtn = document.getElementById("sendBtn");

    let selectedFile = null;
    let preparedDataUrl = null; // —Å–∂–∞—Ç–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ –≤ dataURL (jpeg)

    function showStatus(message, type) {
      status.innerHTML = message;
      status.className = `status-${type}`;
      status.style.display = "block";
    }

    function resetAll() {
      form.reset();
      preview.innerHTML = "";
      meta.textContent = "";
      buttonGroup.style.display = "none";
      status.style.display = "none";
      selectedFile = null;
      preparedDataUrl = null;
      sendBtn.disabled = false;
    }

    cancelBtn.addEventListener("click", resetAll);

    photoInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      if (file.size > MAX_ORIGINAL_MB * 1024 * 1024) {
        showStatus(`‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º ${MAX_ORIGINAL_MB} –ú–ë`, "error");
        return;
      }

      selectedFile = file;

      try {
        showStatus('<div class="spinner"></div><div style="margin-top:10px;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–æ—Ç–æ...</div>', "loading");

        const { dataUrl, width, height } = await compressImageToJpegDataUrl(file, MAX_SIDE, JPEG_QUALITY);
        preparedDataUrl = dataUrl;

        // –ø—Ä–µ–≤—å—é
        preview.innerHTML = `<img src="${dataUrl}" alt="preview">`;

        const approxKb = Math.round((dataUrl.length * 3/4) / 1024); // –≥—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞
        meta.textContent = `–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ: ${width}√ó${height}, ~${approxKb} KB`;

        if (dataUrl.length > MAX_BASE64_CHARS) {
          showStatus("‚ùå –§–æ—Ç–æ –≤—Å—ë –µ—â—ë —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –°–¥–µ–ª–∞–π—Ç–µ —Å–Ω–∏–º–æ–∫ –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏–ª–∏ –±–ª–∏–∂–µ/–±–µ–∑ –∑—É–º–∞, –ª–∏–±–æ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ.", "error");
          buttonGroup.style.display = "none";
          return;
        }

        status.style.display = "none";
        buttonGroup.style.display = "flex";
      } catch (err) {
        console.error(err);
        showStatus("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.", "error");
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!selectedFile || !preparedDataUrl) {
        showStatus("‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ.", "error");
        return;
      }

      sendBtn.disabled = true;
      buttonGroup.style.display = "none";
      showStatus('<div class="spinner"></div><div style="margin-top:10px;">–û—Ç–ø—Ä–∞–≤–∫–∞...</div>', "loading");

      try {
        const fd = new FormData();
        fd.append("access_key", WEB3FORMS_ACCESS_KEY);

        // –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å (Web3Forms –∏—Å–ø–æ–ª—å–∑—É–µ—Ç to/replyto –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫; –¥–æ–±–∞–≤–∏–º —è–≤–Ω—ã–µ –ø–æ–ª—è)
        fd.append("to", TO_EMAIL);

        // –¢–µ–º–∞/–ø–æ–ª—è
        fd.append("subject", '–§–æ—Ç–æ: –†–µ–º–æ–Ω—Ç —ç–ª–µ–∫—Ç—Ä–æ–¥–≤–∏–≥–∞—Ç–µ–ª–µ–π (–ê–û "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –ø—Ç–∏—Ü–µ—Ñ–∞–±—Ä–∏–∫–∞")');
        fd.append("name", "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ (—Å–∞–π—Ç)");
        fd.append("email", "no-reply@energo380.local"); // —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö

        // –°–æ–æ–±—â–µ–Ω–∏–µ + –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∫–∞–∫ dataURL (–≤ –ø–∏—Å—å–º–µ –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç–æ–º; —É–¥–æ–±–Ω–æ –ø–µ—Ä–µ—Å–ª–∞—Ç—å/—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å)
        fd.append("message",
`–ù–æ–≤–æ–µ —Ñ–æ—Ç–æ —Å —Å–∞–π—Ç–∞.

–ò–º—è —Ñ–∞–π–ª–∞ (–æ—Ä–∏–≥.): ${selectedFile.name}
–¢–∏–ø: ${selectedFile.type}
–†–∞–∑–º–µ—Ä (–æ—Ä–∏–≥.): ${(selectedFile.size/1024/1024).toFixed(2)} MB

–ù–ò–ñ–ï dataURL (JPEG). –ï–≥–æ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä/—Ä–µ–¥–∞–∫—Ç–æ—Ä, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É:
${preparedDataUrl}
`);

        // –ê–Ω—Ç–∏-–±–æ—Ç –ø–æ–ª–µ (honeypot)
        fd.append("botcheck", "");

        const res = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          body: fd
        });

        const json = await res.json();
        if (!json.success) {
          throw new Error(json.message || "Web3Forms error");
        }

        showStatus("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É (–≤—Ö–æ–¥—è—â–∏–µ/—Å–ø–∞–º).", "success");
        setTimeout(resetAll, 2500);
      } catch (err) {
        console.error(err);
        showStatus("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.", "error");
        buttonGroup.style.display = "flex";
        sendBtn.disabled = false;
      }
    });

    function compressImageToJpegDataUrl(file, maxSide, quality) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(file);

        img.onload = () => {
          try {
            const { width: w0, height: h0 } = img;

            let w = w0, h = h0;
            const scale = Math.min(1, maxSide / Math.max(w0, h0));
            w = Math.round(w0 * scale);
            h = Math.round(h0 * scale);

            const canvas = document.createElement("canvas");
            canvas.width = w;
            canvas.height = h;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, w, h);

            const dataUrl = canvas.toDataURL("image/jpeg", quality);

            URL.revokeObjectURL(url);
            resolve({ dataUrl, width: w, height: h });
          } catch (e) {
            URL.revokeObjectURL(url);
            reject(e);
          }
        };

        img.onerror = (e) => {
          URL.revokeObjectURL(url);
          reject(e);
        };

        img.src = url;
      });
    }
  </script>
</body>
</html>

